<?xml version="1.0" encoding="utf-8" ?>
<Patch>
	<Operation MayRequire="Atlas.AndroidTiers" Class="PatchOperationSequence">
		<success>Always</success>
		<operations>

			<!-- Исправлена неточность, сообщите разработчику.

			У андроидов M7 и M8 нет кнопки "Персона", хотя в описании персонажа "i" эта вкладка работает. Но у мёртвых кнопка снова появляется! Надо или вернуть её живым, или убрать у мёртвых.
			Дополнительная информация по навыкам - в файле AndroidTiers_Rebalance.xml.
			Виден навык "Животноводство" у M7 и M8, а в описании персонажа отображаются лишние характеристики.
			Пока не найдено решение для этих багов, хотя бы сгладим явное несоответствие по животноводству: -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/TraitDef[defName = "MechAtlas"]/degreeDatas/li[1]</xpath>
				<value>
					<skillGains>
						<li>
							<key>Animals</key>
							<value>-20</value>
						</li>
					</skillGains>
				</value>
			</li>
			<!-- И по характеристикам -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[@Name = "BasePawnMech"]/statBases</xpath>
				<value>
					<TameAnimalChance>0</TameAnimalChance>
					<TrainAnimalChance>0</TrainAnimalChance>
					<BiosculpterOccupantSpeed MayRequire="Ludeon.RimWorld.Ideology">0</BiosculpterOccupantSpeed>
					<GeneralLaborSpeed>0</GeneralLaborSpeed>
					<MedicalTendQuality>0</MedicalTendQuality>
					<MedicalTendSpeed>0</MedicalTendSpeed>
					<DrugHarvestYield>0</DrugHarvestYield>
					<PlantHarvestYield>0</PlantHarvestYield>
					<PlantWorkSpeed>0</PlantWorkSpeed>
					<AnimalGatherYield>0</AnimalGatherYield>
					<AnimalGatherSpeed>0</AnimalGatherSpeed>
					<SmeltingSpeed>0</SmeltingSpeed>
					<ATPP_AndroidTendQuality>0</ATPP_AndroidTendQuality>
				</value>
			</li>

			<!-- Возраст андроидов и механоидов не может быть больше 3400 лет.
			Ещё более вероятно, что все 7 моделей андроидов изобрели в одно время с механоидами.
			Исправляем, иначе в игре будут отрицательные даты рождения -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/PawnKindDef[
				defName = "AndroidT5Colonist" or
				defName = "M7MechPawn" or
				defName = "M8MechPawn"
				]</xpath>
				<value>
					<maxGenerationAge>2500</maxGenerationAge>
				</value>
			</li>

			<!-- Возраст только что созданных андроидов должен быть равен 0, а не 5. Решение пока не найдено, нужно сделать отсчёт возраста от нуля, как у только что рождённых детёнышей животных.
			Стандартное решение приводит к ошибке. Пробовал выставить натуральное число, тоже не помогло:
			<li Class="PatchOperationReplace">
				<xpath>Defs/PawnKindDef[
				defName = "AndroidT1Colonist" or
				defName = "AndroidT2Colonist" or
				defName = "AndroidT3Colonist" or
				defName = "AndroidT4Colonist"
				]/maxGenerationAge/text()</xpath>
				<value>0</value>
			</li>
			Для M7 и M8 это тоже актуально, а там возможно надо будет создать отдельный PawnKindDef для суррогатов.

			Андроиды из пластали не могут заржаветь. Более вероятна запылённость суставов и других движущихся частей. Цвет описания подправлен соответственно: -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/HediffDef[defName = "ATPP_Rusted"]/defaultLabelColor/text()</xpath>
				<value>(255, 255, 255)</value>
			</li>

			<!-- Тип мяса отображается даже при его нулевом количестве.
			В лоре из книги Ф.К.Дика "Снятся ли андроидам электроовцы" не описана биохимия потребления пищи у андроидов, но косвенно можно понять, что она близка к человеческой.
			Вероятно, в них встроен биореактор, как у биороботов из вселенной "Кремль 2222".
			Было бы правильно заменить "мясо альпака" у андроидов на наше "мумиё".
			Но так как внешность андроидов нарисована не по лору, а ближе к роботам, то более логичным ресурсом будет сталь как в трупах механоидов -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/AlienRace.ThingDef_AlienRace[
				defName = "Android1Tier" or
				defName = "Android2Tier" or
				defName = "Android3Tier" or
				defName = "Android4Tier" or
				defName = "Android5Tier" or
				defName = "M7Mech" or
				defName = "M8Mech"
				]/race/useMeatFrom/text()</xpath>
				<value>Mech_Centipede</value>
			</li>
			<!-- Аналогично для дрона и 4 механических питомцев -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[
				defName = "MicroScyther" or
				@Name = "AnimalAndroidThingBase"
				]/race/useMeatFrom/text()</xpath>
				<value>Mech_Centipede</value>
			</li>

			<!-- Тип кожи тоже отображается даже при её нулевом количестве.
			У всех 7 андроидов отключена ранее прописанная шкура мутанта -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/AlienRace.ThingDef_AlienRace[
				defName = "Android1Tier" or
				defName = "Android2Tier" or
				defName = "Android3Tier" or
				defName = "Android4Tier" or
				defName = "Android5Tier" or
				defName = "M7Mech" or
				defName = "M8Mech"
				]/race/leatherDef</xpath>
				<value>
					<useLeatherFrom>Mech_Centipede</useLeatherFrom>
				</value>
			</li>
			<!-- Аналогично для дрона -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "MicroScyther"]/race/leatherDef</xpath>
				<value>
					<useLeatherFrom>Mech_Centipede</useLeatherFrom>
				</value>
			</li>
			<!-- Аналогично для 4 механических питомцев.
			Кроме того, на данном этапе развития мода АТ, почти все робо-животные - металлические машины без съедобных частей, поэтому не могут быть целью хищников -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[
				defName = "AndroidMuff" or
				defName = "AndroidChicken" or
				defName = "RoboticSheep" or
				defName = "AndroidDog"
				]/race/leatherDef</xpath>
				<value>
					<useLeatherFrom>Mech_Centipede</useLeatherFrom>
					<canBePredatorPrey>false</canBePredatorPrey>
				</value>
			</li>
			<!-- Аналогично для механической коровы. Кстати, она пахнет питательным раствором, так что должна привлекать хищников -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "RoboticCow"]/race/leatherDef</xpath>
				<value>
					<useLeatherFrom>Mech_Centipede</useLeatherFrom>
				</value>
			</li>
			<!-- Исправляем функциональные размеры механической коровы для соответствия видимым -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "RoboticCow"]/race/baseBodySize/text()</xpath>
				<value>2.65</value>
			</li>
			<!-- Корректируем числа, чтобы голод остался прежним -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "RoboticCow"]/race/baseHungerRate/text()</xpath>
				<value>0.7</value>
			</li>

			<!-- Убираем кости у андроидов, добавленные модом Rim of Madness - Bones -->
			<li MayRequire="sihv.rombones" Class="PatchOperationAdd">
				<xpath>Defs/AlienRace.ThingDef_AlienRace[
				defName = "Android1Tier" or
				defName = "Android2Tier" or
				defName = "Android3Tier" or
				defName = "Android4Tier" or
				defName = "Android5Tier"
				]/statBases</xpath>
				<value>
					<BoneAmount>0</BoneAmount>
				</value>
			</li>
			<!-- Аналогично для M7, M8, дрона и 5 механических питомцев -->
			<li MayRequire="sihv.rombones" Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[
				@Name = "AnimalAndroidThingBase" or
				@Name = "BasePawnMech" or
				defName = "RoboticCow"
				]/statBases</xpath>
				<value>
					<BoneAmount>0</BoneAmount>
				</value>
			</li>

			<!-- Доделываем скрытую фракцию мутантов.
			Использованы фракталы из книги "Парк юрского периода".
			Цвет подобран, чтобы соответствовать внешнему виду мутанта -->
			<li MayRequire="Ludeon.RimWorld.Ideology" Class="PatchOperationAdd">
				<xpath>Defs/FactionDef[defName = "Abomination"]</xpath>
				<value>
					<factionIconPath>UI/Ideoligions/Universal/CirclesC</factionIconPath>
					<colorSpectrum> <li>(143, 114, 156)</li> </colorSpectrum>
				</value>
			</li>

			<!-- Скрипт MOARANDROIDS.Recipe_RerollTraits. использует все трейты, вместо разрешённых для конкретной расы.
			Кроме того, он добавляет черты характера даже андроидам без личности.
			Пока не найдено решение для этих багов, рецепт мягко отключён -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/RecipeDef[defName = "RerollAndroidTraits"]/workerClass/text()</xpath>
				<value>MOARANDROIDS.Recipe_AndroidRewireSurgery</value>
			</li>

			<!-- Большое оружие мода криво отображалось в слоте выбранного оружия.
			В текстурах обрезаем пустое место -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "Mech40MMCannon"]/graphicData/texPath/text()</xpath>
				<value>Things/Item/40MMCannon_cut</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "MechMastiffGun"]/graphicData/texPath/text()</xpath>
				<value>Things/Item/MechFlakGun_cut</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "MechHandCannon"]/graphicData/texPath/text()</xpath>
				<value>Things/Item/MechPistol_cut</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "MeleeWeapon_MechKnife"]/graphicData/texPath/text()</xpath>
				<value>Things/Item/MechKnife_cut</value>
			</li>
			<!-- Корректируем отображение из-за изменившихся размеров -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "Mech40MMCannon"]/graphicData/drawSize/text()</xpath>
				<value>2.8</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "MechMastiffGun"]/graphicData/drawSize/text()</xpath>
				<value>2.4</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "MechHandCannon"]/graphicData/drawSize/text()</xpath>
				<value>1.8</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "MeleeWeapon_MechKnife"]/graphicData/drawSize/text()</xpath>
				<value>2.1</value>
			</li>
			<!-- Корректируем отображение оружия в руках, добавляя поворот.
			Ещё это оружие криво отображалось в описании и в списке рецептов на верстаке -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[defName = "Mech40MMCannon"]</xpath>
				<value>
					<uiIconScale>0.38</uiIconScale>
					<equippedAngleOffset>-20</equippedAngleOffset>
				</value>
			</li>
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[defName = "MechMastiffGun"]</xpath>
				<value>
					<uiIconScale>0.45</uiIconScale>
					<equippedAngleOffset>-20</equippedAngleOffset>
				</value>
			</li>
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[defName = "MechHandCannon"]</xpath>
				<value>
					<uiIconScale>0.62</uiIconScale>
					<equippedAngleOffset>-20</equippedAngleOffset>
				</value>
			</li>
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[defName = "MeleeWeapon_MechKnife"]</xpath>
				<value>
					<uiIconScale>0.49</uiIconScale>
				</value>
			</li>
			<!-- Заодно подправляем противомеханоидную винтовку -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[defName = "AntiMechRifle"]</xpath>
				<value>
					<uiIconScale>0.7</uiIconScale>
				</value>
			</li>

			<!-- Исправление согласно концепции «12+».

			Внимание! При добавлении нового общего параметра важен алфавитный порядок файлов патчей! В следущих за этим файлах не надо создавать willNeverEat, только ссылаться на него.
			Кроме того, файл с созданной переменной willNeverEat должен относиться к действующему моду.
			Убираем съедобность мёртвых мутанта и дрона -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[@Name = "BasePawn"]</xpath>
				<value>
					<race>
						<willNeverEat>
							<li>Corpse_Abomination</li>
							<li>Corpse_MicroScyther</li>
						</willNeverEat>
					</race>
				</value>
			</li>
			<!-- M8 генерируется не с пустым foodType, как прописано в его AlienRace.ThingDef_AlienRace -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[@Name = "BasePawnMech"]</xpath>
				<value>
					<race>
						<willNeverEat>
							<li>Meat_Human</li>
							<li>Corpse_Human</li>
							<li>Corpse_Abomination</li>
							<li>Corpse_MicroScyther</li>
						</willNeverEat>
					</race>
				</value>
			</li>

			<!-- Аналогично с алфавитным порядком для переменной disallowedThingDefs.
			Убираем разделку бывших людей -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/RecipeDef[defName = "ButcherCorpseFlesh"]/fixedIngredientFilter</xpath>
				<value>
					<disallowedThingDefs>
						<li>Corpse_Abomination</li>
					</disallowedThingDefs>
				</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "Abomination"]/statBases/MeatAmount</xpath>
				<value>
					<MeatAmount>0</MeatAmount>
					<BoneAmount MayRequire="sihv.rombones">0</BoneAmount>
				</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "Abomination"]/statBases/LeatherAmount/text()</xpath>
				<value>0</value>
			</li>

			<!-- Трейты для 7 видов андроидов -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/AlienRace.ThingDef_AlienRace[
				defName = "Android1Tier" or
				defName = "Android2Tier" or
				defName = "Android3Tier" or
				defName = "Android4Tier" or
				defName = "Android5Tier" or
				defName = "M7Mech" or
				defName = "M8Mech"
				]/alienRace/generalSettings/disallowedTraits</xpath>
				<value>
					<li> <defName>Asexual</defName> </li>
					<li> <defName>Bisexual</defName> </li>
					<li> <defName>Cannibal</defName> </li>
					<li> <defName>Gay</defName> </li>
					<!-- Masochist уже отключен у всех 7.
					Pyromaniac уже отключен у всех кроме T5 -->
				</value>
			</li>
			<!-- T5 больше не пироман -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/AlienRace.ThingDef_AlienRace[defName = "Android5Tier"]/alienRace/generalSettings/disallowedTraits</xpath>
				<value>
					<li> <defName>Pyromaniac</defName> </li>
				</value>
			</li>
			<!-- У M7 и M8 уже отключены все мысли параметром cannotReceiveThoughtsAtAll -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/AlienRace.ThingDef_AlienRace[
				defName = "Android1Tier" or
				defName = "Android2Tier" or
				defName = "Android3Tier" or
				defName = "Android4Tier"
				]/alienRace/thoughtSettings/cannotReceiveThoughts</xpath>
				<value>
					<li>ButcheredHumanlikeCorpse</li>
					<li>HarvestedOrgan_Bloodlust</li>
					<li>KilledHumanlikeBloodlust</li>
					<li>KnowButcheredHumanlikeCorpse</li>
					<li>MasochistPain</li>
					<li>PyromaniacHappy</li>
					<li>WitnessedDeathBloodlust</li>
				</value>
			</li>
			<!-- У T5 уже отключены мысли ButcheredHumanlikeCorpse и KnowButcheredHumanlikeCorpse -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/AlienRace.ThingDef_AlienRace[defName = "Android5Tier"]/alienRace/thoughtSettings/cannotReceiveThoughts</xpath>
				<value>
					<li>HarvestedOrgan_Bloodlust</li>
					<li>KilledHumanlikeBloodlust</li>
					<li>MasochistPain</li>
					<li>PyromaniacHappy</li>
					<li>WitnessedDeathBloodlust</li>
				</value>
			</li>
			<!-- Для трейтов из мода VanillaExpanded.VanillaTraitsExpanded изменения внесены в его файле VEtraits_Patch.xml.

			Для замены разделки исправляем недоделанный автором рецепт разборки андроидов. -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/RecipeDef[defName = "ATPP_DisassembleAndroid"]/ingredients/li[1]/filter/categories/li[1]/text()</xpath>
				<value>Corpses</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/RecipeDef[defName = "ATPP_DisassembleAndroid"]/fixedIngredientFilter</xpath>
				<value>
					<uiIconThing>Plasteel</uiIconThing>
					<fixedIngredientFilter>
						<categories>
							<li>Corpses</li>
						</categories>
						<disallowedCategories>
							<li>CorpsesMechanoid</li>
							<li>CorpsesAnimal</li>
						</disallowedCategories>
					</fixedIngredientFilter>
				</value>
			</li>

		</operations>
	</Operation>
</Patch>
