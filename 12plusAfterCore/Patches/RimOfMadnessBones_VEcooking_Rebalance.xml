<?xml version="1.0" encoding="utf-8" ?>

<!-- MIT
Copyright (c) 2018 Rim of Madness Team
Копия лицензии - в файле RimOfMadnessBones_License_MIT.txt

CC BY-NC-ND 4.0
Copyright (c) Sarg Bjornson
Копия лицензии - в файле VEcooking_License_CC_BY_NC_ND_4_0.txt -->

<Patch>
	<Operation MayRequire="sihv.rombones" Class="PatchOperationSequence">
		<success>Always</success>
		<operations>

			<!-- Исправлен баланс, сообщите разработчику.

			Оригинальный патч на механоидов устарел -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[@Name = "BaseMechanoid"]/statBases</xpath>
				<value>
					<BoneAmount>0</BoneAmount>
				</value>
			</li>
			<!-- Иначе человек с костью в руках держит вентилятор -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "BoneItem"]/graphicData/texPath/text()</xpath>
				<value>Things/Item/Resource/OldBone</value>
			</li>
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "BoneItem"]/graphicData/graphicClass/text()</xpath>
				<value>Graphic_StackCount</value>
			</li>
			<!-- Убираем древние строения из кости, отключая возможность добывать из них съедобный костный мозг. Нужно решение поизящнее - интегрировать в генератор как древесину, но пока что найдено такое: -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "BoneItem"]/stuffProps/commonality/text()</xpath>
				<value>0</value>
			</li>
			<!-- Рецепт пластали больше подходит плавильне, т.к. сплавы обычно требуют высоких температур -->
			<li Class="PatchOperationRemove">
				<xpath>Defs/ThingDef[defName = "BiofuelRefinery"]/recipes/li[5]</xpath>
			</li>
			<li Class="PatchOperationAdd">
				<xpath>Defs/RecipeDef[defName = "MakeBonePlasteel"]</xpath>
				<value>
					<recipeUsers>
						<li>ElectricSmelter</li>
					</recipeUsers>
				</value>
			</li>
			<!-- В реале вытащенный костный мозг хранится дня 4, это игровых 2 дня. А то выставленные полтора года - это ни в какие ворота -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "ROMB_Marrow"]/comps/li[1]/daysToRotStart/text()</xpath>
				<value>2</value>
			</li>
			<!-- Добавляем воспламеняемость изделиям из костей - чуть больше, чем у стали. Сырые кости и стены из крупных костей оставляем негорючими, типа из-за влаги от костного мозга -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[defName = "BoneItem"]/stuffProps/statFactors/Flammability/text()</xpath>
				<value>0.5</value>
			</li>
			<!-- Для маски и брони горючесть сделаем чуть повыше - за счёт ремешков крепежа. Так как здесь используются кости целиком, а не композит, как в остальных изделиях -->
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[
				defName = "ROMB_Apparel_SkullMask" or
				defName = "Sihv_Apparel_BoneArmor"
				]/statBases</xpath>
				<value>
					<Flammability>0.7</Flammability>
				</value>
			</li>
			<!-- Исправляем баг версии 1.3 с отображением маски -->
			<li Class="PatchOperationRemove">
				<xpath>Defs/ThingDef[defName = "ROMB_Apparel_SkullMask"]/apparel/wornGraphicPaths/li[2]</xpath>
			</li>
			<!-- Исправляем чит - фарфоровая плитка была доступна до исследования остальных. Заодно слегка перебалансируем её по аналогии с ванильными плиткой и бетоном -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/TerrainDef[defName = "BoneChinaFloor"]/designationCategory</xpath>
				<value>
					<designatorDropdown>Floor_Tile</designatorDropdown>
					<researchPrerequisites>
						<li>Stonecutting</li>
					</researchPrerequisites>
					<constructionSkillPrerequisite>3</constructionSkillPrerequisite>
				</value>
			</li>
			<!-- Аналогично категоризируем блоки фарфора и костяного бетона, у них даже описания подходят -->
			<li Class="PatchOperationReplace">
				<xpath>Defs/ThingDef[
				defName = "Bonecrete" or
				defName = "BoneChina"
				]/thingCategories/li[1]/text()</xpath>
				<value>StoneBlocks</value>
			</li>
			<!-- Для пропатченных блоков корректируем рецепт из мода VE cooking -->
			<li MayRequire="VanillaExpanded.VCookE" Class="PatchOperationAdd">
				<xpath>Defs/RecipeDef[defName = "VCE_MakeSaltfromBlocks"]/fixedIngredientFilter</xpath>
				<value>
					<disallowedThingDefs>
						<li>Bonecrete</li>
						<li>BoneChina</li>
					</disallowedThingDefs>
				</value>
			</li>

<!-- Далее - наработки кода, попытка приблизить кости к реальности. Нормальное решение пока не найдено -->
			<!-- Исправлен баланс, сообщите разработчику, что добавлено гниение костей, в реале 3 недели, то есть 11 игровых дней -->
<!-- Пока не получается стандартным способом, просто добавлю маркер, если балансеры одобрят. Только надо решить проблему быстрого гниения, вероятно по примеру древесины 0.5, но не факт
			<li Class="PatchOperationAdd">
				<xpath>Defs/ThingDef[defName = "BoneItem"]</xpath>
				<value>
					<comps>
						<li Class="CompProperties_Rottable">
							<daysToRotStart>11</daysToRotStart>
							<rotDestroys>false</rotDestroys>
						</li>
 -->
<!-- Сделал comps по примеру желатина, вообще нет эффекта:
						<li Class="CompProperties_Ingredients" />
-->
<!--
					</comps>
					<tickerType>Rare</tickerType>
				</value>
			</li>
-->
			<!-- И запрещаем добывать костный мозг из тухлятины -->

<!-- Не могу придумать как. Пока есть только кривой способ, поселенцы зависают около стола: -->
<!--
			<li Class="PatchOperationAdd">
				<xpath>Defs/RecipeDef[defName = "MakeMarrowFromBone"]</xpath>
				<value>
					<interruptIfIngredientIsRotting>true</interruptIfIngredientIsRotting>
				</value>
			</li>
-->
<!-- Сделал по примеру "разделать тушу", вообще нет эффекта:
			<li Class="PatchOperationAdd">
				<xpath>Defs/RecipeDef[defName = "MakeMarrowFromBone"]/fixedIngredientFilter</xpath>
				<value>
					<specialFiltersToDisallow>
						<li>AllowRotten</li>
					</specialFiltersToDisallow>
				</value>
			</li>
Возможно, есть путь раздвоения типов костей на сухие и съедобные. С односторонним превращением как в VE F Insectoids при ломке по королевскому желе. Или в Android Tiers при съедении фрактальных таблеток.
-->
		</operations>
	</Operation>
</Patch>
